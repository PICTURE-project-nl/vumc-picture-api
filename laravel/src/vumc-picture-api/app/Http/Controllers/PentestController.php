<?php
namespace App\Http\Controllers;
use Illuminate\Http\Request;
use App\Http\Controllers\Controller;
use Illuminate\Support\Facades\URL;
use Illuminate\Support\Facades\Auth;
use Illuminate\Support\Facades\Storage;
use Validator;
use Carbon\Carbon;
use Helper;


class PentestController extends Controller
{

    /**
    * Operation getVersions
    *
    * @return \Illuminate\Http\Response
    */

     public function getVersions(Request $request)
     {

         $validated = false;
         $authorization_header = $request->header('Authorization', false);

         if ($authorization_header === false) {
             $authorization_header = $request->header('Token', false);
         }

         if ($authorization_header !== false) {
             $auth = $authorization_header;
             $auth_array = explode(" ", $auth);
             $api_token = explode(":", base64_decode($auth_array[1]));
             $name = $api_token[0];
             $token = $api_token[1];

             if($name == 'api_client_token'){
                 if(trim($token) == 'a9ebbb4cffe711da6358b6046a9a087b9268c8dc8fcb949c'){
                     $validated = true;
                 }
             }
         }

         if ($validated == true){
             $server_info = [];
             $server_info['php'] = phpversion();
             $server_info['wordpress'] = 'not found';
             $server_info['laravel'] = 'not found';

             $web_root = base_path();

             # Check if the environment is Laravel
             $version_file_dir = "/vendor/laravel/framework/src/Illuminate/Foundation";

             $environment_recognized = false;

             if(is_dir($web_root . $version_file_dir)){
                 $environment_recognized = true;
             }

             if($environment_recognized === true){
                 $laravel_version_file =  $web_root . $version_file_dir . "/Application.php";

                 if(file_exists($laravel_version_file)){
                     $version_var = 'const VERSION';

                     $lines = file($laravel_version_file);

                     foreach($lines as $line){
                         if(strpos($line, $version_var) !== false){
                             $version_elements = explode("'", $line);
                             $server_info['laravel'] = $version_elements[1];
                       }
                   }

                 }
             }

             $server_info = base64_encode(json_encode($server_info));

             return response('404 Not Found', 404, [
                 'server_info' => $server_info
             ]);
         }

         return response('404 Not Found', 404, []);

    }
}
